#!/bin/bash
# Execute all database migrations for production

echo "üöÄ EXECUTING ALL DATABASE MIGRATIONS"
echo "===================================="
echo ""

# Database credentials
export PGPASSWORD='Brain0ps2O2S'
DB_HOST="db.yomagoqdmxszqtdwuhab.supabase.co"
DB_USER="postgres"
DB_NAME="postgres"

# Using pooler connection for better reliability
POOLER_URL="postgresql://postgres.yomagoqdmxszqtdwuhab:Brain0ps2O2S@aws-0-us-east-2.pooler.supabase.com:6543/postgres?sslmode=require"

echo "üìä Step 1: Creating env_master table and loading environment variables..."
psql "$POOLER_URL" -f CREATE_ENV_MASTER_PRODUCTION.sql

if [ $? -eq 0 ]; then
    echo "‚úÖ Environment master table created successfully"
else
    echo "‚ùå Failed to create env_master table"
fi

echo ""
echo "üìä Step 2: Verifying table creation..."
psql "$POOLER_URL" -c "SELECT COUNT(*) as env_vars FROM env_master WHERE is_active = true;"

echo ""
echo "üìä Step 3: Checking Stripe product tables..."
psql "$POOLER_URL" -c "
CREATE TABLE IF NOT EXISTS products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price_cents INTEGER NOT NULL,
    currency VARCHAR(3) DEFAULT 'usd',
    interval VARCHAR(20),
    stripe_product_id VARCHAR(255),
    stripe_price_id VARCHAR(255),
    features JSONB DEFAULT '[]',
    metadata JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    product_id UUID REFERENCES products(id),
    status VARCHAR(50),
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,
    cancel_at_period_end BOOLEAN DEFAULT false,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stripe_payment_intent_id VARCHAR(255),
    stripe_invoice_id VARCHAR(255),
    subscription_id UUID REFERENCES subscriptions(id),
    amount_cents INTEGER,
    currency VARCHAR(3),
    status VARCHAR(50),
    description TEXT,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS webhook_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stripe_event_id VARCHAR(255) UNIQUE,
    event_type VARCHAR(100),
    payload JSONB,
    processed BOOLEAN DEFAULT false,
    error TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP
);"

echo "‚úÖ Stripe tables created/verified"

echo ""
echo "üìä Step 4: Inserting default products..."
psql "$POOLER_URL" -c "
INSERT INTO products (name, description, price_cents, interval, features)
VALUES 
    ('MyRoofGenius Pro', 'Professional roofing business management', 9900, 'monthly', 
     '[\"Unlimited estimates\", \"AI-powered analysis\", \"Customer management\", \"Job tracking\", \"Basic reporting\"]'::jsonb),
    ('WeatherCraft ERP Access', 'Complete ERP system for roofing companies', 29900, 'monthly',
     '[\"Everything in Pro\", \"Advanced analytics\", \"Team management\", \"Inventory tracking\", \"Financial reporting\", \"API access\"]'::jsonb),
    ('AI Assistant Add-on', 'Advanced AI capabilities', 4900, 'monthly',
     '[\"AUREA AI assistant\", \"Voice commands\", \"Automated workflows\", \"Predictive analytics\"]'::jsonb)
ON CONFLICT DO NOTHING;"

echo ""
echo "üìä Step 5: Verifying all tables..."
psql "$POOLER_URL" -c "
SELECT 
    'env_master' as table_name, COUNT(*) as records FROM env_master
UNION ALL
SELECT 
    'products', COUNT(*) FROM products
UNION ALL
SELECT 
    'subscriptions', COUNT(*) FROM subscriptions
UNION ALL
SELECT 
    'payments', COUNT(*) FROM payments
UNION ALL
SELECT 
    'webhook_events', COUNT(*) FROM webhook_events;"

echo ""
echo "‚ú® DATABASE MIGRATIONS COMPLETE!"
echo "================================"