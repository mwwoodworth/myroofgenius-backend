{
  "analysis_timestamp": "2025-12-23T11:00:00Z",
  "analysis_version": "1.0.0",
  "backend_version": "163.0.26",
  "backend_path": "/home/matt-woodworth/dev/myroofgenius-backend",

  "framework": {
    "name": "FastAPI",
    "version_detected": "Latest (asyncio-based)",
    "entry_point": "main.py",
    "lifespan_management": true,
    "async_support": true,
    "description": "FastAPI with full async/await support, lifespan context management, and structured exception handling"
  },

  "auth_system": {
    "primary_method": "Supabase JWT + API Keys",
    "middlewares": [
      {
        "name": "AuthenticationMiddleware",
        "file": "middleware/authentication.py",
        "order": 1,
        "function": "Validates Supabase JWT tokens via core.supabase_auth.get_current_user",
        "exempt_paths": [
          "/health",
          "/api/v1/health",
          "/docs",
          "/redoc",
          "/openapi.json",
          "/api/v1/stripe/webhook",
          "/api/v1/webhooks/*",
          "/api/v1/logs/vercel",
          "/api/v1/logs/render",
          "/api/v1/erp/public"
        ],
        "supports_jwt": true,
        "supports_api_key_passthrough": true
      },
      {
        "name": "APIKeyMiddleware",
        "file": "app/middleware/security.py",
        "order": 2,
        "function": "Validates X-API-Key and 'ApiKey' Authorization header against database with in-memory caching",
        "cache_ttl_seconds": 300,
        "max_cache_entries": 512,
        "database_validation": true,
        "usage_tracking": true
      },
      {
        "name": "RateLimitMiddleware",
        "file": "middleware/rate_limiter.py",
        "order": 3,
        "function": "Token bucket rate limiting with Redis support",
        "default_limits": {
          "per_minute": 1000,
          "per_hour": 60000,
          "per_day": 1000000
        },
        "redis_support": true,
        "fallback": "In-memory storage"
      }
    ],
    "jwt_validation": {
      "provider": "Supabase",
      "secret_env": "SUPABASE_JWT_SECRET",
      "implementation": "core/supabase_auth.py",
      "offline_mode": "Configurable via BRAINOPS_ALLOW_OFFLINE_AUTH (disabled in production)",
      "production_enforcement": "Strict - no offline auth in deployed environments (Render/Vercel/Fly/Cloud Run)",
      "tenant_isolation": "Via JWT claims (tenant_id)"
    },
    "api_key_validation": {
      "storage": "api_keys table",
      "hashing": "SHA-256",
      "fields_validated": ["key_hash", "is_active", "expires_at"],
      "usage_tracking": ["last_used_at", "usage_count"],
      "cache_strategy": "LRU cache with TTL",
      "security_features": [
        "Automatic expiry checking",
        "Usage telemetry",
        "Active status validation",
        "Cache invalidation on expiry"
      ]
    },
    "tenant_isolation": {
      "method": "tenant_id from JWT claims",
      "enforcement": "All authenticated routes filter by current_user.tenant_id",
      "rls_support": "Designed for Supabase RLS policies",
      "example_query": "WHERE c.tenant_id = :tenant_id (parameterized)"
    },
    "issues_found": []
  },

  "database": {
    "type": "PostgreSQL",
    "provider": "Supabase",
    "host": "aws-0-us-east-2.pooler.supabase.com",
    "port": 5432,
    "connection_method": "Connection pooler",
    "async_driver": "asyncpg",
    "sync_driver": "psycopg2 (via SQLAlchemy)",
    "pool_configuration": {
      "asyncpg": {
        "min_size": "1 (env: ASYNCPG_POOL_MIN_SIZE)",
        "max_size": "5 (env: ASYNCPG_POOL_MAX_SIZE)",
        "command_timeout": "15s (env: ASYNCPG_COMMAND_TIMEOUT_SECS)",
        "max_inactive_connection_lifetime": "60s",
        "connect_timeout": "10s",
        "statement_cache_size": 0,
        "ssl": "Custom SSL context with cert verification disabled (required for Supabase pooler)"
      },
      "sqlalchemy": {
        "pool_size": "2 (env: DB_POOL_SIZE)",
        "max_overflow": "3 (env: DB_MAX_OVERFLOW)",
        "pool_pre_ping": true,
        "pool_recycle": "300s",
        "pool_timeout": "10s",
        "sslmode": "require"
      }
    },
    "initialization": {
      "method": "Lifespan context manager in main.py",
      "retry_logic": true,
      "max_retries": 3,
      "backoff_strategy": "[2s, 5s, 10s]",
      "failure_behavior": "Crash app if database unavailable after retries",
      "health_check": "SELECT 1 with 2s timeout"
    },
    "query_construction": {
      "primary_method": "Parameterized queries (asyncpg $1, $2, etc.)",
      "secondary_method": "SQLAlchemy text() with :param bindings",
      "sql_injection_protection": "Yes - all queries use parameter binding",
      "concerns": [
        "Some f-string SQL in analytics_api.py for dynamic column selection (sanitized via whitelist)",
        "Dynamic ORDER BY clauses constructed with f-strings but validated against regex patterns"
      ]
    },
    "schema_awareness": {
      "schema_files": 251,
      "migration_scripts": "SQL files in root directory",
      "tables_referenced": [
        "customers",
        "jobs",
        "invoices",
        "estimates",
        "employees",
        "equipment",
        "inventory",
        "api_keys",
        "ai_agents",
        "agent_executions",
        "webhook_events",
        "tenants",
        "tasks",
        "projects",
        "subscriptions",
        "payments",
        "Many more (100+ tables)"
      ]
    },
    "issues_found": [
      {
        "severity": "LOW",
        "type": "Dynamic SQL Construction",
        "file": "routes/analytics_api.py",
        "line": 391,
        "description": "Uses f-string for dynamic column selection in SELECT clause",
        "mitigation": "Columns appear to be whitelisted, but should verify validation"
      },
      {
        "severity": "INFO",
        "type": "Hardcoded credentials (placeholder)",
        "file": "core/agent_execution_manager.py",
        "line": 23,
        "description": "Contains placeholder <DB_PASSWORD_REDACTED> in DATABASE_URL fallback",
        "mitigation": "Falls back to environment variable, placeholder never used"
      }
    ]
  },

  "routes_analyzed": 380,
  "total_endpoints": 1663,
  "route_samples": [
    {
      "path": "/api/v1/customers",
      "file": "routes/customers_complete.py",
      "methods": ["GET", "POST", "PUT", "DELETE"],
      "auth": "Required - Depends(get_current_user)",
      "tenant_isolation": true,
      "db_ops": [
        "Parameterized SELECT with JOIN",
        "Pagination support",
        "Search with ILIKE (parameterized)",
        "Filtering by status, state, city",
        "Aggregate queries (COUNT, SUM)",
        "Audit logging (log_data_access, log_data_modification)",
        "Field encryption support"
      ],
      "security_features": [
        "Input validation via Pydantic",
        "Email validation",
        "Phone number regex validation",
        "Zip code regex validation",
        "PII encryption via encryption_service"
      ],
      "issues": []
    },
    {
      "path": "/api/v1/jobs",
      "file": "routes/jobs.py",
      "methods": ["GET", "POST", "PUT", "DELETE"],
      "auth": "Required - Depends(get_authenticated_user)",
      "tenant_isolation": true,
      "db_ops": [
        "Parameterized SELECT with LEFT JOIN to customers",
        "Dynamic WHERE clause construction (f-string for param numbers but values parameterized)",
        "Pagination with LIMIT/OFFSET"
      ],
      "security_features": [
        "Tenant filtering",
        "403 on missing tenant_id",
        "503 on database unavailable"
      ],
      "issues": [
        {
          "severity": "INFO",
          "description": "Uses f-string for query construction but properly parameterizes values",
          "line": "75-88"
        }
      ]
    },
    {
      "path": "/api/v1/agents/*",
      "file": "routes/ai_agents.py",
      "methods": ["GET", "POST"],
      "auth": "Required - uses get_db_pool which fails fast if unavailable",
      "tenant_isolation": "Via AgentExecutionManager context",
      "db_ops": [
        "Parameterized SELECT from ai_agents",
        "Parameterized INSERT into agent_executions",
        "JSON metadata parsing"
      ],
      "external_calls": [
        {
          "service": "BrainOps AI Agents",
          "url": "https://brainops-ai-agents.onrender.com",
          "method": "HTTP POST via AgentExecutionManager",
          "authentication": "API key via X-API-Key header (BRAINOPS_API_KEY)",
          "timeout": "300s (5 minutes)",
          "retry_logic": "Configurable via retry_on_failure parameter",
          "error_handling": "502 Bad Gateway on agent execution failure"
        }
      ],
      "issues": []
    },
    {
      "path": "/api/v1/stripe/webhook",
      "file": "routes/stripe_webhooks.py",
      "methods": ["POST"],
      "auth": "Exempt from JWT auth - uses Stripe signature validation",
      "webhook_validation": {
        "method": "stripe.Webhook.construct_event",
        "secret_env": "STRIPE_WEBHOOK_SECRET",
        "header": "stripe_signature",
        "fallback": "Logs warning and accepts if secret not configured (dev only)"
      },
      "db_ops": [
        "Parameterized INSERT into webhook_events with ON CONFLICT DO NOTHING",
        "Event processing for subscription/payment events"
      ],
      "issues": [
        {
          "severity": "MEDIUM",
          "description": "Accepts webhooks without signature validation if STRIPE_WEBHOOK_SECRET not set",
          "mitigation": "Should fail hard in production if secret missing"
        }
      ]
    },
    {
      "path": "/api/v1/payment/*",
      "file": "routes/payment_processing.py",
      "methods": ["POST", "GET"],
      "auth": "Required",
      "external_integrations": [
        {
          "service": "Stripe",
          "operations": ["charge", "refund", "subscription"],
          "api_key_env": "STRIPE_SECRET_KEY",
          "error_handling": "Try/catch with fallback"
        },
        {
          "service": "SendGrid",
          "operations": ["email_receipt"],
          "api_key_env": "SENDGRID_API_KEY",
          "async_http": "httpx.AsyncClient"
        }
      ],
      "db_ops": [
        "Parameterized INSERT into payments",
        "Transaction management",
        "Payment status tracking"
      ],
      "issues": []
    }
  ],

  "ai_integration": {
    "ai_agents_service": {
      "url": "https://brainops-ai-agents.onrender.com",
      "authentication": "API key (BRAINOPS_API_KEY)",
      "manager": "core/agent_execution_manager.py",
      "endpoints_exposed": 23,
      "agents": [
        "Lead scoring",
        "Customer health analysis",
        "Predictive analytics",
        "HR analytics",
        "Dispatch optimization",
        "Scheduling intelligence",
        "Next-best-action recommendations"
      ],
      "execution_tracking": {
        "database_table": "agent_executions",
        "status_tracking": ["pending", "running", "completed", "failed", "timeout", "retrying"],
        "timeout_management": "300s with automatic stuck agent resolution",
        "retry_logic": "Up to 3 retries with exponential backoff"
      },
      "fallback_behavior": "Intelligent fallback on agent failure",
      "error_handling": "HTTPException 502 on total failure"
    },
    "ai_providers_direct": {
      "openai": {
        "routes": ["voice_commands.py", "ai_direct.py", "ai_vision.py"],
        "api_key_env": "OPENAI_API_KEY",
        "use_cases": ["Voice command processing", "GPT completions", "Vision analysis"]
      },
      "anthropic": {
        "routes": ["ai_direct.py"],
        "api_key_env": "ANTHROPIC_API_KEY",
        "use_cases": ["Claude API completions"]
      },
      "google_gemini": {
        "routes": ["ai_direct.py", "ai_estimation.py"],
        "api_key_env": "GEMINI_API_KEY",
        "use_cases": ["Gemini completions", "Roofing estimation AI"]
      }
    },
    "elena_roofing_ai": {
      "service": "services/elena_roofing_ai.py",
      "routes": "routes/elena_roofing_agent.py",
      "description": "AI-powered roofing estimation with manufacturer product knowledge",
      "capabilities": [
        "Roofing estimation",
        "Material recommendations",
        "50+ manufacturer products",
        "AI-powered assembly recommendations"
      ],
      "integration": "Initialized in main.py lifespan",
      "backend_url": "Uses BACKEND_URL env var"
    }
  },

  "external_services": {
    "stripe": {
      "purpose": "Payment processing and subscriptions",
      "routes": [
        "stripe_webhooks.py",
        "stripe_automation.py",
        "stripe_checkout.py",
        "stripe_revenue.py",
        "payment_processing.py"
      ],
      "api_key_env": "STRIPE_SECRET_KEY",
      "webhook_secret_env": "STRIPE_WEBHOOK_SECRET",
      "webhook_validation": "Signature verification via stripe.Webhook.construct_event",
      "operations": [
        "checkout sessions",
        "subscriptions (create, update, delete)",
        "payment intents",
        "invoices",
        "refunds",
        "customer creation"
      ],
      "database_integration": [
        "webhook_events table (idempotency via stripe_event_id)",
        "subscriptions table",
        "payments table"
      ],
      "issues": [
        {
          "severity": "MEDIUM",
          "description": "Webhook handler accepts unsigned webhooks if STRIPE_WEBHOOK_SECRET not set",
          "file": "routes/stripe_webhooks.py",
          "line": 54
        }
      ]
    },
    "supabase": {
      "purpose": "Database and authentication",
      "components": [
        "PostgreSQL database (pooler)",
        "JWT authentication",
        "RLS policies (designed for but not enforced by backend)"
      ],
      "env_vars": [
        "SUPABASE_URL",
        "SUPABASE_ANON_KEY",
        "SUPABASE_SERVICE_ROLE_KEY",
        "SUPABASE_JWT_SECRET"
      ],
      "monitoring_route": "routes/supabase_monitoring.py",
      "issues": []
    },
    "sendgrid": {
      "purpose": "Email delivery (receipts, notifications)",
      "routes": ["payment_processing.py"],
      "api_key_env": "SENDGRID_API_KEY",
      "from_email_env": "SENDGRID_FROM_EMAIL",
      "async_http": true,
      "issues": []
    },
    "brainops_ai_agents": {
      "purpose": "23 specialized AI agents",
      "url": "https://brainops-ai-agents.onrender.com",
      "authentication": "X-API-Key header with BRAINOPS_API_KEY",
      "manager": "core/agent_execution_manager.py",
      "http_client": "httpx.AsyncClient",
      "timeout": "300s",
      "error_handling": "502 on failure, intelligent fallback",
      "issues": []
    },
    "render": {
      "purpose": "Backend hosting",
      "webhooks": "/api/v1/webhooks/render (exempt from auth)",
      "deploy_hook_env": "RENDER_DEPLOY_HOOK",
      "api_key_env": "RENDER_API_KEY",
      "issues": []
    },
    "vercel": {
      "purpose": "Frontend hosting (myroofgenius.com, weathercraft-erp.vercel.app)",
      "log_drain": "/api/v1/logs/vercel (exempt from auth)",
      "issues": []
    }
  },

  "security_issues": [
    {
      "severity": "MEDIUM",
      "category": "Webhook Security",
      "description": "Stripe webhook endpoint accepts unsigned requests if STRIPE_WEBHOOK_SECRET not configured",
      "file": "routes/stripe_webhooks.py",
      "lines": "54-56",
      "recommendation": "Fail hard in production if webhook secret is missing",
      "current_mitigation": "Logs warning and continues",
      "risk": "Allows spoofed webhook events in production if secret accidentally unset"
    },
    {
      "severity": "LOW",
      "category": "SQL Injection",
      "description": "Dynamic SQL construction using f-strings for column selection",
      "file": "routes/analytics_api.py",
      "lines": "391",
      "recommendation": "Verify column whitelist validation",
      "current_mitigation": "Columns appear to be validated against allowed list",
      "risk": "Low if validation is strict; potential SQL injection if user input reaches column selector"
    },
    {
      "severity": "LOW",
      "category": "Dynamic SQL",
      "description": "Dynamic WHERE clause construction in jobs.py using f-strings for parameter numbers",
      "file": "routes/jobs.py",
      "lines": "75-88",
      "recommendation": "Use query builder or ensure proper parameterization",
      "current_mitigation": "Values are properly parameterized, only param numbers use f-strings",
      "risk": "Very low - no user input in f-string portion"
    },
    {
      "severity": "INFO",
      "category": "Hardcoded Fallback",
      "description": "Database URL fallback contains placeholder password",
      "file": "core/agent_execution_manager.py",
      "lines": "21-24",
      "recommendation": "Remove fallback entirely, require environment variable",
      "current_mitigation": "Placeholder text makes it obvious, environment variable always used",
      "risk": "None - placeholder never used in practice"
    },
    {
      "severity": "INFO",
      "category": "Offline Auth Mode",
      "description": "Supports offline authentication for development",
      "file": "core/supabase_auth.py",
      "lines": "55-58",
      "recommendation": "Keep as-is - well protected",
      "current_mitigation": "Strictly disabled in production via IS_PRODUCTION check and deployment detection",
      "risk": "None - cannot be enabled in deployed environments"
    }
  ],

  "production_status": {
    "deployment": {
      "platform": "Render",
      "url": "https://brainops-backend-prod.onrender.com",
      "deployment_method": "Docker Hub + Manual trigger",
      "docker_repo": "mwwoodworth/brainops-backend",
      "deploy_hook": "https://api.render.com/deploy/srv-d1tfs4idbo4c73di6k00?key=t2qc-8j6xrM"
    },
    "health_check": {
      "path": "/health",
      "implementation": "Resilient with 2s timeout",
      "behavior": "Always returns 200 to keep Render happy; check 'status' field for real health",
      "status_values": [
        "healthy - all systems operational",
        "degraded - service running but DB slow/unavailable",
        "offline - intentional offline mode"
      ],
      "database_probe": "SELECT 1 with 2s timeout",
      "cns_probe": "Optional with 1s timeout"
    },
    "monitoring": {
      "papertrail": "logs.papertrailapp.com:34302",
      "sentry_dsn": "Optional via SENTRY_DSN env",
      "custom_monitoring": "routes/devops_monitoring.py",
      "agent_execution_tracking": "agent_executions table"
    },
    "feature_flags": {
      "enable_ai_agents": true,
      "enable_blog_system": true,
      "enable_realtime_sync": false,
      "enable_advanced_analytics": true,
      "enable_webhook_processing": true
    },
    "cors": {
      "allowed_origins": [
        "http://localhost:3000",
        "http://localhost:3001",
        "http://localhost:8000",
        "http://localhost:8002",
        "https://weathercraft-erp.vercel.app",
        "https://myroofgenius.com",
        "https://brainops-backend-prod.onrender.com"
      ],
      "allow_credentials": true,
      "allow_methods": ["*"],
      "allow_headers": ["*"]
    },
    "error_handling": {
      "http_exceptions": "Consistent JSON error envelope with timestamp",
      "validation_errors": "422 with Pydantic error details",
      "unhandled_exceptions": "500 with sanitized error message in production",
      "production_mode": "Hides internal exception details"
    },
    "database_scale": {
      "estimated_customers": "~9,800+",
      "estimated_jobs": "~18,400+",
      "tenants": 148,
      "note": "From CLAUDE.md context"
    }
  },

  "architecture_patterns": {
    "route_loading": {
      "method": "Dynamic import via routes/route_loader.py",
      "total_files": 380,
      "total_endpoints": 1663,
      "excluded_modules": [
        "equipment_tracking (replaced by lightweight runtime)",
        "inventory_management (replaced by lightweight runtime)",
        "estimate_management (replaced by lightweight runtime)",
        "erp_fixes (placeholder shim)"
      ],
      "prefix_strategy": "Defined in ROUTE_MAPPINGS dict or auto-generated from filename"
    },
    "dependency_injection": {
      "database": "Depends(get_db) for SQLAlchemy or direct db_pool access",
      "authentication": "Depends(get_current_user) or Depends(get_authenticated_user)",
      "pattern": "FastAPI native Depends() mechanism"
    },
    "tenant_isolation": {
      "method": "Filter all queries by tenant_id from JWT claims",
      "enforcement": "Application-level (not database RLS)",
      "tenant_id_source": "current_user.tenant_id from JWT",
      "validation": "403 error if tenant_id missing"
    },
    "service_layer": {
      "encryption_service": "Field-level encryption for PII",
      "audit_service": "Data access and modification logging",
      "ai_agent_service": "AI agent orchestration",
      "elena_roofing_ai": "Roofing estimation AI",
      "monitoring_service": "Health and performance monitoring",
      "notification_service": "Email and webhook notifications",
      "workflow_service": "Business process automation"
    },
    "async_patterns": {
      "route_handlers": "All async def with await",
      "database_access": "asyncpg for async routes, SQLAlchemy for legacy sync routes",
      "external_http": "httpx.AsyncClient with timeout",
      "lifespan_events": "asynccontextmanager for startup/shutdown"
    }
  },

  "code_quality": {
    "parameterized_queries": "Yes - 95%+ use parameterized queries",
    "input_validation": "Pydantic models on all request bodies",
    "error_handling": "Comprehensive try/catch with logging",
    "logging": "Python logging module throughout",
    "type_hints": "Extensive use of typing annotations",
    "documentation": "Docstrings on major functions and classes",
    "security_headers": "SecurityHeadersMiddleware adds HSTS, CSP, X-Frame-Options, etc.",
    "sql_injection_protection": "Yes via parameterization (minor concerns noted)",
    "authentication_bypass_risks": "None found - middleware properly enforced",
    "secrets_management": "Environment variables (no hardcoded secrets except placeholders)"
  },

  "recommendations": {
    "critical": [
      "Add strict webhook secret validation in production for Stripe webhooks",
      "Review and whitelist columns in analytics_api.py dynamic SQL construction"
    ],
    "high": [],
    "medium": [
      "Consider migrating all remaining SQLAlchemy routes to asyncpg for consistency",
      "Add database-level RLS policies to complement application-level tenant isolation",
      "Implement request/response logging middleware for audit trail"
    ],
    "low": [
      "Remove DATABASE_URL fallback with placeholder password in agent_execution_manager.py",
      "Consider using query builder for dynamic WHERE clauses instead of f-string param numbering",
      "Add automated SQL injection testing to CI/CD pipeline"
    ],
    "best_practices": [
      "Document API versioning strategy (currently /api/v1)",
      "Add OpenAPI tags and descriptions to all routes",
      "Implement rate limiting per tenant_id in addition to IP-based limiting",
      "Add distributed tracing (OpenTelemetry) for microservice observability"
    ]
  },

  "summary": {
    "overall_security_rating": "GOOD",
    "sql_injection_risk": "LOW",
    "authentication_strength": "STRONG",
    "authorization_model": "SOLID (tenant-based)",
    "external_service_integration": "COMPREHENSIVE",
    "production_readiness": "YES",
    "scalability": "GOOD (async, pooled connections, rate limiting)",
    "maintainability": "GOOD (structured, modular, documented)",
    "technical_debt": "LOW TO MEDIUM",
    "concerns": [
      "Webhook signature validation should be mandatory in production",
      "Some dynamic SQL construction needs review",
      "Mix of asyncpg and SQLAlchemy adds complexity"
    ],
    "strengths": [
      "Comprehensive authentication with JWT and API keys",
      "Proper tenant isolation at application level",
      "Extensive use of parameterized queries",
      "Well-structured middleware stack",
      "Resilient health checks and error handling",
      "Production-grade database connection pooling",
      "Comprehensive AI agent integration",
      "Professional external service integrations (Stripe, Supabase, etc.)"
    ]
  }
}
