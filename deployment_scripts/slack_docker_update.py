#!/usr/bin/env python3
"""Send Docker deployment instructions to Slack"""

import requests
import json
from datetime import datetime

SLACK_WEBHOOK_URL = "https://hooks.slack.com/services/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"

def send_docker_update():
    """Send Docker deployment instructions"""
    
    blocks = [
        {
            "type": "header",
            "text": {
                "type": "plain_text",
                "text": "üê≥ Docker Image v3.1.172 Ready - Deployment Instructions"
            }
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"*Time:* {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}"
            }
        },
        {
            "type": "divider"
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*‚úÖ Docker Image Confirmed:*\n‚Ä¢ Image: `mwwoodworth/brainops-backend:v3.1.172`\n‚Ä¢ Also tagged as: `latest`\n‚Ä¢ Built: 24 minutes ago\n‚Ä¢ Size: 2.41GB\n‚Ä¢ Contains: Complete Slack integration"
            }
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*üîß Render Deployment Fix:*\n\nThe issue is that Render is still pulling v3.1.171. To fix:\n\n1. Go to Render Dashboard ‚Üí BrainOps Backend\n2. Check Docker Image URL setting\n3. **Option A:** Change to specific version:\n   `mwwoodworth/brainops-backend:v3.1.172`\n4. **Option B:** Force pull latest:\n   - Clear build cache\n   - Redeploy with `latest` tag"
            }
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*üìã What's New in v3.1.172:*\n‚Ä¢ Complete Slack two-way integration\n‚Ä¢ ClaudeOS command processor\n‚Ä¢ Multi-agent routing system\n‚Ä¢ Redis command queue\n‚Ä¢ Event handler endpoints"
            }
        },
        {
            "type": "divider"
        },
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*‚ö° Quick Deploy Command:*\n```\ndocker pull mwwoodworth/brainops-backend:v3.1.172\n```"
            }
        },
        {
            "type": "context",
            "elements": [
                {
                    "type": "mrkdwn",
                    "text": "üí° If Render continues to pull v3.1.171, check if it's caching the 'latest' tag"
                }
            ]
        }
    ]
    
    payload = {
        "text": "Docker Image v3.1.172 Ready - Deployment Instructions",
        "blocks": blocks,
        "username": "ClaudeOS",
        "icon_emoji": "üê≥"
    }
    
    try:
        response = requests.post(SLACK_WEBHOOK_URL, json=payload)
        if response.status_code == 200:
            print("‚úÖ Docker instructions sent to Slack")
        else:
            print(f"‚ùå Failed: {response.status_code}")
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")

if __name__ == "__main__":
    send_docker_update()